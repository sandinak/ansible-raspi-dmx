---
- name: setup raspi config
  hosts: pi_builder
  gather_facts: no
  vars:
    iso_path: /Users/branson/Documents/Images/2021-10-30-raspios-bullseye-armhf-lite.img

  pre_tasks:
    - name: check for mounted drive with FAT_32
      changed_when: false
      tags: 
        - unmount
        -  burnt
      shell: 
        diskutil list |
        grep -B 4 FAT_32 |
        grep \/dev\/ |
        awk '{ print $1 }'
      register: _diskutil_list
      failed_when: _diskutil_list.stdout_lines | length == 0

    - name: extract disk name from {{ _diskutil_list }}
      tags: 
        - unmount
        - burnt
      set_fact:
        disk_device_name: "{{ _diskutil_list.stdout.split('/')[-1] }}"
 
    - name: force unmount disk {{disk_device_name}}
      tags: unmount
      become: yes
      shell: diskutil unmountDisk force {{disk_device_name}}
    
    - name: burn image {{iso_path}} -> /dev/r{{disk_device_name}}
      become: yes
      shell: dd 
        if={{iso_path}} 
        of=/dev/r{{disk_device_name}}
        bs=512k
    
    - name: check for mount of /Volumes/boot
      tags: burnt
      wait_for: 
        path: /Volumes/boot

    - name: enable ssh
      tags: burnt
      file:
        state: touch
        path: /Volumes/boot/ssh

  roles: 
    - { role: pi-builder/wifi,
        tags: ['wifi', 'burnt'] }

  post_tasks: 
    - name: final unmount disk {{disk_device_name}}
      tags: unmount, burnt
      become: yes
      shell: diskutil unmountDisk force {{disk_device_name}}
    
    - name: say finished
      tags: burnt
      say: 
        msg: burn on {{disk_device_name}} complete.
        
 
