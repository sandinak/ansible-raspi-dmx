---
- name: Configure a raspi instance for DMX Hat
  hosts: dmx_controllers
  become: yes
  vars:
    tty_device: ttyAMA0
    apt_packages:
      - lsof
      - tcpdump
      - nmap

  pre_tasks:
#    - name: set hostname
#      hostname:
#        name: "{{inventory_hostname}}"
#      
#    - name: update the pi 
#      apt:
#         force: yes
#         update_cache: yes
#         cache_valid_time: 86400
#      register: _apt_update
#         
#    - name: upgrade if needed
#      apt:
#         upgrade: yes
#      when: _apt_update is changed
#   
#    - name: install packages
#      apt: 
#        name: "{{item}}"
#      with_items: "{{apt_packages}}"
#
#    - name: check for {{tty_device}} serial device
#      shell: ls /dev/{{tty_device}}
#      changed_when: false
      
  roles:
    - raspi/dmx_hat/configure
    - { role: ola/olad/configure,
        plugins: "{{ola_plugins}}" }

    # patch ARTNet to uartDMX on configured universe
    - { role: ola/patch,
        plugin: artnet,
        port: 0,
        universe: "{{ola_universe_id}}" }
    - { role: ola/patch,
        plugin: uartdmx,
        port: 0,
        universe: "{{ola_universe_id}}" }
        
  